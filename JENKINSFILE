pipeline {
    agent none

     stages {
        stage('Get Code') {
			agent { label ‘SCM’ }
            steps {
                // Obtener código del repo
                git 'https://github.com/naxo1979/RepoDevOpsIPY_PUB'
				stash includes: ‘/app/**’, name: ‘app’
				stash includes: ‘/test/**’, name: ‘test’
            }
        }
    
        stage('Build') {
			agent { label ‘Build’ }
			steps {
              echo 'Eyyy, esto es Python. No hay que compilar nada!!!'
	          echo WORKSPACE
              bat 'dir'
           }
        }
		stage('Tests') {

			parallel {
				stage('Unit') {
				agent { label ‘Tests’ }
				unstash name: ‘test’
					steps {
						catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
							bat '''
								set PYTHONPATH=%WORKSPACE%
								pytest --junitxml=result-unit.xml test\\unit
							'''
						}
					}
				}   


				stage('Rest') {
				agent { label ‘Tests’ }
				unstash name: ‘test’
					steps {
						bat '''
							set FLASK_APP=app\\api.py
							set FLASK_ENV=development
							start flask run
							start java -jar C:\\DevOps\\Jenkins\\root\\workspace\\wiremock-standalone-3.3.1.jar --port 9090 --root-dir C:\\DevOps\\Jenkins\\root\\workspace
							set PYTHONPATH=%WORKSPACE%
							pytest --junitxml=result-rest.xml test\\rest
						'''
					}    
				}
			}
		}

        stage('Results') {
			agent { label ‘Result’ }		
            steps {
                junit 'result*.xml' 
            }
        }
     
		stage('Deploy') {
			agent { label ‘Deploy’ }
			steps{
				echo 'Etapa simulada de deploy en Master!!!'
			}
			
		}	
	 
    }
}
}
